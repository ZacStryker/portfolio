{% extends "base.html" %}

{% block title %}Customer Segmentation - Zac Stryker{% endblock %}

{% block head_extra %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-customer-segmentation">
<div class="project-header">
    <h1>Customer Segmentation</h1>
    <p class="subtitle">Interactive K-means++ clustering with RFM analysis</p>
</div>

<div class="main-card">
    <!-- Metrics badges -->
    <div class="metrics-row">
        <div class="metric-badge cyan">
            <span class="label">Iterations:</span>
            <span class="value" id="metricIterations">0</span>
            <span class="info-tip">
                <span class="tip-icon">?</span>
                <span class="tip-content">Number of iterations the K-means algorithm took to converge. Fewer iterations with K-means++ initialization indicates better starting centroids.</span>
            </span>
        </div>
        <div class="metric-badge pink">
            <span class="label">Silhouette:</span>
            <span class="value" id="metricSilhouette">0.000</span>
            <span class="info-tip">
                <span class="tip-icon">?</span>
                <span class="tip-content">Silhouette score ranges from -1 to 1, measuring how well-defined the clusters are. Scores above 0.5 indicate good clustering, 0.3-0.5 is acceptable, and below 0.3 suggests overlapping clusters.</span>
            </span>
        </div>
        <div class="metric-badge yellow">
            <span class="label">Algorithm:</span>
            <span class="value" id="metricAlgorithm">K-MEANS++</span>
            <span class="info-tip">
                <span class="tip-icon">?</span>
                <span class="tip-content">K-means++ uses smart initialization by selecting starting centroids that are far apart, leading to faster convergence and better quality. Random initialization picks centroids randomly, which can lead to suboptimal results.</span>
            </span>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-grid">
        <div class="control-group">
            <label class="control-label">Clusters (K)</label>
            <input type="range" id="kSlider" min="2" max="8" value="4">
            <div class="k-display">
                <span class="k-bound">2</span>
                <span class="k-val" id="kValue">4</span>
                <span class="k-bound">8</span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">
                Feature Space
                <span class="info-tip">
                    <span class="tip-icon">?</span>
                    <span class="tip-content">Feature space determines which customer attributes are used for clustering. Different combinations reveal different segmentation patterns.</span>
                </span>
            </label>
            <div class="metric-btns">
                <button class="metric-btn active" data-metric="monetary-frequency">Monetary &times; Frequency</button>
                <button class="metric-btn" data-metric="recency-monetary">Recency &times; Monetary</button>
                <button class="metric-btn" data-metric="recency-frequency">Recency &times; Frequency</button>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Options</label>
            <div class="options-col">
                <label class="option-row">
                    <input type="checkbox" id="chkKMeansPP" checked>
                    <span>Use K-means++ Initialization</span>
                </label>
                <label class="option-row">
                    <input type="checkbox" id="chkCentroids" checked>
                    <span>Show Centroids</span>
                </label>
                <button class="btn-regenerate" id="btnRegenerate">Regenerate Data</button>
            </div>
        </div>
    </div>

    <!-- Main charts grid -->
    <div class="content-grid">
        <!-- Main scatter -->
        <div class="viz-panel">
            <div class="viz-panel-header">
                <span class="viz-panel-title">
                    Cluster Visualization
                    <span class="info-tip">
                        <span class="tip-icon">?</span>
                        <span class="tip-content">Each point is a customer colored by cluster. Cross marks show cluster centroids. Watch points migrate between clusters as the algorithm iterates.</span>
                    </span>
                </span>
                <span class="step-indicator">Step: <span id="stepCurrent">1</span> / <span id="stepTotal">1</span></span>
            </div>
            <div class="chart-wrap">
                <canvas id="scatterChart"></canvas>
            </div>

            <!-- Animation controls -->
            <div class="anim-controls">
                <button class="anim-btn play" id="btnPlay">&#9654; Play</button>
                <button class="anim-btn pause" id="btnPause" disabled>&#10074;&#10074; Pause</button>
                <button class="anim-btn reset" id="btnReset">&#9632; Reset</button>
                <div class="speed-control">
                    <span class="speed-label">Speed:</span>
                    <input type="range" id="speedSlider" min="100" max="1000" step="100" value="500">
                    <span class="speed-value" id="speedValue">2.0x</span>
                </div>
            </div>
        </div>

        <!-- Right side: convergence + elbow -->
        <div class="viz-panel">
            <div class="viz-panel-title">
                Convergence History
                <span class="info-tip">
                    <span class="tip-icon">?</span>
                    <span class="tip-content">Inertia measures total within-cluster sum of squared distances. As K-means iterates, inertia decreases until convergence. A steeper drop indicates faster optimization.</span>
                </span>
            </div>
            <div class="chart-wrap-sm">
                <canvas id="convergenceChart"></canvas>
            </div>

            <div class="side-section-title pink">
                Elbow Method
                <span class="info-tip">
                    <span class="tip-icon">?</span>
                    <span class="tip-content">The elbow method helps determine optimal K. The "elbow" point where the curve bends indicates diminishing returns from adding more clusters. Silhouette scores measure cluster quality: higher is better.</span>
                </span>
            </div>
            <div class="chart-wrap-sm">
                <canvas id="elbowChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Cluster stats -->
    <div class="cluster-stats-header">
        <h3>
            RFM Cluster Statistics
            <span class="info-tip">
                <span class="tip-icon">?</span>
                <span class="tip-content">RFM (Recency, Frequency, Monetary) analysis segments customers based on purchase recency, purchase frequency, and total spending. Each cluster represents a distinct customer segment.</span>
            </span>
        </h3>
    </div>
    <div class="cluster-stats-grid" id="clusterStats"></div>
</div>

<div class="overview-card">
    <h3>README.md</h3>
    <p>Interactive K-means++ clustering visualization with RFM (Recency, Frequency, Monetary) analysis. Watch the algorithm converge step-by-step with animated scatter plots, then evaluate cluster quality with silhouette scores and the elbow method.</p>

    <h4>Features</h4>
    <ul>
        <li><strong>Adjustable K</strong> -- slider to select 2&ndash;8 clusters</li>
        <li><strong>Feature space selection</strong> -- Monetary &times; Frequency, Recency &times; Monetary, or Recency &times; Frequency</li>
        <li><strong>K-means++ vs Random</strong> -- toggle initialization strategy to compare convergence</li>
        <li><strong>Animated convergence</strong> -- step through iterations and watch data points migrate between clusters</li>
        <li><strong>Elbow method chart</strong> -- visualize inertia across K values to find the optimal cluster count</li>
        <li><strong>Silhouette score</strong> -- quantitative measure of cluster cohesion and separation</li>
        <li><strong>RFM segment labels</strong> -- clusters are mapped to customer archetypes (Champions, Loyal Customers, At Risk, etc.)</li>
    </ul>

    <h4>How It Works</h4>
    <p>Everything runs <strong>client-side</strong> in JavaScript. The K-means++ algorithm is implemented from scratch:</p>
    <ol>
        <li>Smart centroid initialization (K-means++) selects initial centroids proportional to squared distance</li>
        <li>Assignment step assigns each point to the nearest centroid</li>
        <li>Update step moves centroids to the mean of their assigned points</li>
        <li>Repeat until convergence (centroids stop moving)</li>
    </ol>
    <p>Each iteration is rendered as an animation frame on a Chart.js scatter plot.</p>

    <h4>Tech Stack</h4>
    <ul>
        <li><strong>Chart.js</strong> -- scatter plots, line charts, and elbow method visualization</li>
        <li><strong>Vanilla JavaScript</strong> -- full K-means++ implementation, animation system, state management</li>
        <li><strong>Flask</strong> -- serves the page (no backend computation)</li>
    </ul>
</div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('customer_segmentation.static', filename='script.js') }}"></script>
{% endblock %}
