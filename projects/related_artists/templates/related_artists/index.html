{% extends "base.html" %}

{% block title %}Related Artists - Zac Stryker{% endblock %}

{% block content %}
<div class="project-header">
    <h1>Related Artists</h1>
    <p class="subtitle">Discover connections between musical artists using Discogs data</p>
</div>

<div class="main-card">
    <div class="search-toolbar">
        <div class="search-box">
            <input type="text" id="artistInput" placeholder="Enter artist or band name (e.g., The Red Hot Chili Peppers)">
            <button id="searchBtn" class="btn-primary" onclick="searchArtist()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
        </div>
    </div>

    <h3 id="quickSearchHeader" class="quick-search-header">Quick Search</h3>
    <div id="quickSearchCards" class="quick-search-cards">
        <div class="quick-card" onclick="searchForArtist('Plini')">
            <img src="https://i.discogs.com/71ujIn67FNG550m6r76MX6PIn_VRwcJkElQQvRJZRkA/rs:fit/g:sm/q:90/h:400/w:600/czM6Ly9kaXNjb2dz/LWRhdGFiYXNlLWlt/YWdlcy9BLTM1MTE0/OTYtMTQ3Mjk1MzE0/OS0yNzQwLmpwZWc.jpeg" alt="Plini">
            <div class="quick-card-info">
                <span class="quick-card-name">Plini</span>
                <button class="btn-quick-search"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
            </div>
        </div>
        <div class="quick-card" onclick="searchForArtist('Polyphia')">
            <img src="https://i.discogs.com/Lkg0kUTGwqc92f4_OvCu5fYbrgN5gTesx79SaLj0Az4/rs:fit/g:sm/q:90/h:531/w:600/czM6Ly9kaXNjb2dz/LWRhdGFiYXNlLWlt/YWdlcy9BLTQwNjc2/MTgtMTY2NzMxNjcz/Ny03NzMyLmpwZWc.jpeg" alt="Polyphia">
            <div class="quick-card-info">
                <span class="quick-card-name">Polyphia</span>
                <button class="btn-quick-search"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
            </div>
        </div>
        <div class="quick-card" onclick="searchForArtist('Yvette Young')">
            <img src="https://i.discogs.com/SyRCM1g-08QxyJ6GIiiNdzyPm9FZ-uOWYXSaGdWGLk8/rs:fit/g:sm/q:40/h:150/w:150/czM6Ly9kaXNjb2dz/LWRhdGFiYXNlLWlt/YWdlcy9BLTM5MDky/OTEtMTU4NTY1MTE0/NC03NTkxLmpwZWc.jpeg" alt="Yvette Young">
            <div class="quick-card-info">
                <span class="quick-card-name">Yvette Young</span>
                <button class="btn-quick-search"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg></button>
            </div>
        </div>
    </div>

    <div id="raError" class="ra-error"></div>

    <div id="raResults" class="ra-results"></div>

    <div id="loadMoreContainer" class="load-more-container">
        <button class="btn-primary load-more-btn" onclick="loadMore()">Load More Results</button>
    </div>

    <div id="progressContainer" class="progress-container">
        <div class="progress-bar-container">
            <div id="progressBar" class="progress-bar" style="width: 0%;">
                <span id="progressText">0%</span>
            </div>
        </div>
        <div id="progressDetails" class="progress-details">Initializing...</div>
    </div>
</div>

<div class="overview-card">
    <h3>README.md</h3>
    <p>Discover connections between musical artists by exploring collaborator networks. Search for any artist and find guest appearances, featured collaborations, and band members through the Discogs music database API. Results stream in real-time as they are discovered.</p>

    <h4>Features</h4>
    <ul>
        <li><strong>Artist search</strong> -- type any artist or band name</li>
        <li><strong>Streaming results</strong> -- collaborators appear in real-time via Server-Sent Events as releases are processed</li>
        <li><strong>Pause/resume</strong> -- results are delivered in batches of 12; pause to browse, resume to load more</li>
        <li><strong>Sorting</strong> -- by name (alphabetical), year (latest collaboration), or role</li>
        <li><strong>Relationship categories</strong> -- Members, Guests (featured on the artist's tracks), Appearances (tracks where the artist appears on others' releases)</li>
        <li><strong>7-day cache</strong> -- repeated searches return instantly from a local JSON cache</li>
    </ul>

    <h4>How It Works</h4>
    <ol>
        <li>The backend searches Discogs for the artist and fetches up to 100 releases</li>
        <li>For each release, track-level credits are parsed to identify collaborators</li>
        <li>Collaborators are streamed to the frontend via SSE as they are found</li>
        <li>After every 12 new collaborators, processing pauses until the user resumes</li>
        <li>Results are cached to disk for 7 days to avoid redundant API calls</li>
    </ol>

    <h4>Tech Stack</h4>
    <ul>
        <li><strong>Discogs API</strong> (<code>python3-discogs-client</code>) -- artist search, release data, track credits, images</li>
        <li><strong>Flask</strong> -- SSE streaming endpoint, image proxy routes, cancel/resume API</li>
        <li><strong>Server-Sent Events</strong> -- real-time result streaming without WebSockets</li>
        <li><strong>Threading</strong> -- non-blocking background processing with queue-based communication</li>
    </ul>

    <h4>SSE Event Types</h4>
    <div class="overview-table-wrapper">
        <table>
            <thead><tr><th>Type</th><th>Description</th></tr></thead>
            <tbody>
                <tr><td><code>progress</code></td><td>General progress update with percentage</td></tr>
                <tr><td><code>artist_info</code></td><td>Found the main artist with profile data</td></tr>
                <tr><td><code>collaborator</code></td><td>A new collaborator with release info</td></tr>
                <tr><td><code>paused</code></td><td>Batch complete, waiting for resume</td></tr>
                <tr><td><code>complete</code></td><td>Search finished with full results</td></tr>
                <tr><td><code>cached</code></td><td>Results returned from cache</td></tr>
                <tr><td><code>error</code></td><td>Something went wrong</td></tr>
            </tbody>
        </table>
    </div>

    <h4>API Endpoints</h4>
    <div class="overview-table-wrapper">
        <table>
            <thead><tr><th>Method</th><th>Path</th><th>Description</th></tr></thead>
            <tbody>
                <tr><td>GET</td><td><code>/related-artists/search_stream</code></td><td>SSE stream of results</td></tr>
                <tr><td>POST</td><td><code>/related-artists/cancel</code></td><td>Cancel an active search</td></tr>
                <tr><td>POST</td><td><code>/related-artists/resume</code></td><td>Resume a paused search</td></tr>
                <tr><td>GET</td><td><code>/related-artists/fetch_image/&lt;id&gt;</code></td><td>Fetch artist image</td></tr>
                <tr><td>GET</td><td><code>/related-artists/fetch_release_image/&lt;id&gt;</code></td><td>Fetch album artwork</td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const BASE_URL = {{ url_for('related_artists.index') | tojson }}.replace(/\/$/, '');

    let eventSource = null;
    let currentSearchId = null;
    let imageObserver = null;
    let currentResultsData = null;
    let currentSortField = 'name';
    let currentSortDirection = 'asc';
    let sortDirections = { name: 'asc', year: 'desc', role: 'asc' };
    let loadedImages = {};
    let loadedReleaseImages = {};
    let fetchAbortController = null;
    let streamingCollaborators = {};
    let streamingArtistInfo = null;

    function setupImageObserver() {
        if (imageObserver) imageObserver.disconnect();
        imageObserver = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (!entry.isIntersecting) return;
                const img = entry.target;
                const artistId = img.dataset.artistId;
                const releaseId = img.dataset.releaseId;
                if (img.classList.contains('release-overlay') && releaseId && !img.dataset.loaded) {
                    img.dataset.loaded = 'true';
                    loadReleaseImage(img, releaseId);
                } else if (artistId && !img.dataset.loaded) {
                    img.dataset.loaded = 'true';
                    loadArtistImage(img, artistId);
                }
                imageObserver.unobserve(img);
            });
        }, { rootMargin: '50px' });
    }

    function loadArtistImage(img, artistId) {
        if (loadedImages[artistId]) { img.src = loadedImages[artistId]; img.classList.remove('loading'); return; }
        const releaseId = img.dataset.releaseId || '';
        const url = releaseId ? `${BASE_URL}/fetch_image/${artistId}?release_id=${releaseId}` : `${BASE_URL}/fetch_image/${artistId}`;
        fetch(url, { signal: fetchAbortController?.signal })
            .then(r => r.json())
            .then(data => { img.src = data.image; img.classList.remove('loading'); loadedImages[artistId] = data.image; })
            .catch(err => { if (err.name === 'AbortError') return; const fb = 'https://via.placeholder.com/200x200?text=No+Image'; img.src = fb; img.classList.remove('loading'); loadedImages[artistId] = fb; });
    }

    function loadReleaseImage(img, releaseId) {
        if (loadedReleaseImages[releaseId]) {
            if (loadedReleaseImages[releaseId] === 'HIDE') { img.style.display = 'none'; return; }
            img.src = loadedReleaseImages[releaseId]; img.classList.remove('loading'); return;
        }
        fetch(`${BASE_URL}/fetch_release_image/${releaseId}`, { signal: fetchAbortController?.signal })
            .then(r => r.json())
            .then(data => {
                if (data.error || !data.image) { img.style.display = 'none'; loadedReleaseImages[releaseId] = 'HIDE'; }
                else { img.src = data.image; img.classList.remove('loading'); loadedReleaseImages[releaseId] = data.image; }
            })
            .catch(err => { if (err.name === 'AbortError') return; img.style.display = 'none'; loadedReleaseImages[releaseId] = 'HIDE'; });
    }

    function observeImages() {
        setupImageObserver();
        document.querySelectorAll('.card-image[data-artist-id]').forEach(img => {
            const aid = img.dataset.artistId;
            if (aid && loadedImages[aid]) { img.src = loadedImages[aid]; img.classList.remove('loading'); }
            else imageObserver.observe(img);
        });
        document.querySelectorAll('.release-overlay[data-release-id]').forEach(img => {
            const rid = img.dataset.releaseId;
            if (rid && loadedReleaseImages[rid]) {
                if (loadedReleaseImages[rid] === 'HIDE') img.style.display = 'none';
                else { img.src = loadedReleaseImages[rid]; img.classList.remove('loading'); }
            } else imageObserver.observe(img);
        });
    }

    window.searchArtist = function() {
        const artistName = document.getElementById('artistInput').value.trim();
        if (!artistName) { showError('Please enter an artist name'); return; }
        if (fetchAbortController) fetchAbortController.abort();
        fetchAbortController = new AbortController();
        if (eventSource) cancelSearch();

        loadedImages = {};
        loadedReleaseImages = {};
        streamingCollaborators = {};
        streamingArtistInfo = null;
        currentResultsData = null;

        const progressContainer = document.getElementById('progressContainer');
        const error = document.getElementById('raError');
        const results = document.getElementById('raResults');
        document.getElementById('quickSearchHeader').style.display = 'none';
        document.getElementById('quickSearchCards').style.display = 'none';

        progressContainer.style.display = 'block';
        error.style.display = 'none';
        results.innerHTML = '';
        document.getElementById('loadMoreContainer').style.display = 'none';

        currentSortField = 'name';
        currentSortDirection = 'asc';
        sortDirections = { name: 'asc', year: 'desc', role: 'asc' };

        updateProgress(0, 'Checking cache...');
        currentSearchId = Date.now().toString();

        eventSource = new EventSource(`${BASE_URL}/search_stream?artist=${encodeURIComponent(artistName)}&search_id=${currentSearchId}`);

        eventSource.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'progress') {
                updateProgress(data.progress, data.message);
            } else if (data.type === 'artist_info') {
                updateProgress(data.progress, data.message);
                streamingArtistInfo = data.artist_info;
                currentResultsData = { artist: data.artist_info.name, discogs_url: data.artist_info.url, relations: {}, total_relations: 0, schema: data.artist_info.schema, from_cache: false, limited_results: false };
                initializeStreamingDisplay(data.artist_info);
            } else if (data.type === 'collaborator') {
                updateProgress(data.progress, data.message);
                addCollaboratorToResults(data.collaborator);
            } else if (data.type === 'paused') {
                progressContainer.style.display = 'none';
                document.getElementById('loadMoreContainer').style.display = 'block';
                setTimeout(() => observeImages(), 100);
            } else if (data.type === 'complete') {
                eventSource.close(); eventSource = null;
                progressContainer.style.display = 'none';
                document.getElementById('loadMoreContainer').style.display = 'none';
                displayResults(data.result);
            } else if (data.type === 'error') {
                eventSource.close(); eventSource = null;
                progressContainer.style.display = 'none';
                document.getElementById('loadMoreContainer').style.display = 'none';
                showError(data.message);
            } else if (data.type === 'cached') {
                eventSource.close(); eventSource = null;
                progressContainer.style.display = 'none';
                document.getElementById('loadMoreContainer').style.display = 'none';
                displayResults(data.result);
            }
        };

        eventSource.onerror = function() {
            eventSource.close(); eventSource = null;
            progressContainer.style.display = 'none';
            showError('Connection error occurred');
        };
    };

    function cancelSearch() {
        if (eventSource) { eventSource.close(); eventSource = null; }
        if (currentSearchId) {
            fetch(`${BASE_URL}/cancel`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ search_id: currentSearchId }) });
        }
        document.getElementById('progressContainer').style.display = 'none';
        document.getElementById('loadMoreContainer').style.display = 'none';
        currentSearchId = null;
    }

    function buildSortControlsHtml() {
        const fields = [
            { key: 'name', label: 'Name' },
            { key: 'year', label: 'Year' },
            { key: 'role', label: 'Role' },
        ];
        let html = '<div class="sort-controls"><span class="sort-label">Sort:</span>';
        for (const f of fields) {
            const active = currentSortField === f.key ? ' active' : '';
            const arrow = currentSortField === f.key ? (currentSortDirection === 'asc' ? '&#8593;' : '&#8595;') : '';
            html += `<button class="sort-btn${active}" onclick="sortResults('${f.key}', this)">${f.label}<span class="sort-direction">${arrow}</span></button>`;
        }
        html += '</div>';
        return html;
    }

    function initializeStreamingDisplay(artistInfo) {
        const results = document.getElementById('raResults');
        let headerHtml = '';
        if (typeof artistInfo === 'object') {
            if (artistInfo.schema && artistInfo.schema.image) headerHtml += `<img src="${artistInfo.schema.image}" alt="${artistInfo.name}" class="ra-artist-image" onerror="this.style.display='none'">`;
            headerHtml += `<div class="ra-artist-header-content"><h2>${artistInfo.name}</h2><a href="${artistInfo.url}" target="_blank">View on Discogs &rarr;</a>${artistInfo.schema && artistInfo.schema.description ? `<div class="artist-profile">${formatProfileText(artistInfo.schema.description)}</div>` : ''}</div>`;
        } else {
            headerHtml = `<div class="ra-artist-header-content"><h2>${artistInfo}</h2></div>`;
        }
        results.innerHTML = `<div class="ra-artist-header">${headerHtml}</div><div class="collabs-header-row"><h3 class="collabs-subheader">Collabs</h3>${buildSortControlsHtml()}</div><div class="cards-scroll-wrapper"><div id="streamingCards" class="cards-grid"></div></div>`;
        streamingCollaborators = {};
    }

    function addCollaboratorToResults(collaborator) {
        let container = document.getElementById('streamingCards');
        if (!container) { initializeStreamingDisplay('Artist'); container = document.getElementById('streamingCards'); }
        const collabKey = `${collaborator.role}:${collaborator.name}`;
        if (streamingCollaborators[collabKey]) return;
        streamingCollaborators[collabKey] = true;

        if (currentResultsData) {
            if (!currentResultsData.relations[collaborator.role]) currentResultsData.relations[collaborator.role] = [];
            currentResultsData.relations[collaborator.role].push({ name: collaborator.name, id: collaborator.id, release_id: collaborator.release_id, releases: collaborator.releases, image: collaborator.image || '' });
            currentResultsData.total_relations++;
        }

        const escapedName = collaborator.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const hasImage = collaborator.id ? `data-artist-id="${collaborator.id}"` : '';
        const hasRelease = collaborator.release_id ? `data-release-id="${collaborator.release_id}"` : '';
        const relationClass = collaborator.role.toLowerCase().replace(/\s+/g, '-');
        container.insertAdjacentHTML('beforeend', `
            <div class="artist-card">
                <div class="card-content">
                    <div class="card-header">
                        <div class="ra-artist-name">${collaborator.name}</div>
                        <span class="relation-badge ${relationClass}">${collaborator.role}</span>
                    </div>
                    <div class="ra-artist-releases">${collaborator.releases}</div>
                    <div class="card-actions">
                        <button class="btn-search" onclick="searchForArtist('${escapedName}')">Search</button>
                        <a href="https://www.discogs.com/artist/${collaborator.id}" target="_blank" class="btn-discogs">Discogs</a>
                    </div>
                </div>
            </div>
        `);
        setupImageObserver();
    }

    function updateProgress(percent, message) {
        document.getElementById('progressBar').style.width = percent + '%';
        document.getElementById('progressText').textContent = Math.round(percent) + '%';
        document.getElementById('progressDetails').textContent = message;
    }

    function showError(message) {
        const el = document.getElementById('raError');
        el.textContent = message;
        el.style.display = 'block';
    }

    window.sortResults = function(field, buttonElement) {
        if (!currentResultsData) return;
        if (currentSortField === field) sortDirections[field] = sortDirections[field] === 'asc' ? 'desc' : 'asc';
        currentSortField = field;
        currentSortDirection = sortDirections[field];
        displayResults(currentResultsData, false);
    };

    window.loadMore = function() {
        document.getElementById('loadMoreContainer').style.display = 'none';
        document.getElementById('progressContainer').style.display = 'block';
        // Abort pending image fetches so /resume gets a connection slot immediately
        if (fetchAbortController) fetchAbortController.abort();
        fetchAbortController = new AbortController();
        // Reset aborted images so they can be re-observed later
        document.querySelectorAll('.card-image.loading[data-loaded], .release-overlay.loading[data-loaded]').forEach(img => {
            delete img.dataset.loaded;
        });
        fetch(`${BASE_URL}/resume`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ search_id: currentSearchId }), signal: fetchAbortController.signal })
            .then(() => setTimeout(() => observeImages(), 500))
            .catch(() => {});
    };

    function getLatestYear(releases) {
        const m = releases.match(/\((\d{4})\)/g);
        if (!m || !m.length) return 0;
        return Math.max(...m.map(s => { const y = s.match(/\d{4}/); return y ? parseInt(y[0]) : 0; }));
    }

    function getRoleOrder(role) { return { Member: 1, Guests: 2, Appearances: 3 }[role] || 999; }

    function formatProfileText(text) {
        if (!text) return '';
        return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function displayResults(data, isNewSearch) {
        if (isNewSearch !== false) currentResultsData = data;
        const results = document.getElementById('raResults');
        let html = '<div class="ra-artist-header">';
        if (data.schema && data.schema.image) html += `<img src="${data.schema.image}" alt="${data.artist}" class="ra-artist-image" onerror="this.style.display='none'">`;
        html += `<div class="ra-artist-header-content"><h2>${data.artist}${data.from_cache ? '<span class="cache-badge">Cached</span>' : ''}</h2><a href="${data.discogs_url}" target="_blank">View on Discogs &rarr;</a>${data.schema && data.schema.description ? `<div class="artist-profile">${formatProfileText(data.schema.description)}</div>` : ''}</div></div>`;

        if (!Object.keys(data.relations).length) {
            html += '<p style="color:var(--text-muted)">No related artists found in the Discogs database.</p>';
        } else {
            const all = [];
            for (const [type, artists] of Object.entries(data.relations)) {
                for (const a of artists) all.push({ ...a, relationType: type, latestYear: getLatestYear(a.releases || '') });
            }
            all.sort((a, b) => {
                let c = 0;
                if (currentSortField === 'name') c = a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                else if (currentSortField === 'year') c = b.latestYear - a.latestYear;
                else if (currentSortField === 'role') { c = getRoleOrder(a.relationType) - getRoleOrder(b.relationType); if (!c) c = a.name.toLowerCase().localeCompare(b.name.toLowerCase()); }
                return currentSortDirection === 'asc' ? c : -c;
            });

            html += '<div class="collabs-header-row"><h3 class="collabs-subheader">Collabs</h3>' + buildSortControlsHtml() + '</div><div class="cards-scroll-wrapper"><div id="streamingCards" class="cards-grid">';
            for (const artist of all) {
                const esc = artist.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const hasImage = artist.id ? `data-artist-id="${artist.id}"` : '';
                const hasRelease = artist.release_id ? `data-release-id="${artist.release_id}"` : '';
                const cached = artist.id && loadedImages[artist.id];
                const imgClass = cached ? 'card-image' : (artist.id ? 'card-image loading' : 'card-image');
                const imgSrc = cached ? cached : (artist.id ? '' : 'https://via.placeholder.com/200x200?text=No+Image');
                const relClass = artist.relationType.toLowerCase().replace(/\s+/g, '-');
                html += `
                    <div class="artist-card">
                        <div class="card-content">
                            <div class="card-header">
                                <div class="ra-artist-name">${artist.name}</div>
                                <span class="relation-badge ${relClass}">${artist.relationType}</span>
                            </div>
                            ${artist.releases ? `<div class="ra-artist-releases">${artist.releases}</div>` : ''}
                            <div class="card-actions">
                                <button class="btn-search" onclick="searchForArtist('${esc}')">Search</button>
                                <a href="https://www.discogs.com/artist/${artist.id}" target="_blank" class="btn-discogs">Discogs</a>
                            </div>
                        </div>
                    </div>`;
            }
            html += '</div></div>';
            html += `<div class="ra-stats">Found ${data.total_relations} related artist${data.total_relations !== 1 ? 's' : ''} across ${Object.keys(data.relations).length} relationship type${Object.keys(data.relations).length !== 1 ? 's' : ''}${data.from_cache ? ' (loaded from cache)' : ''}${data.limited_results ? '<br><em>Results limited to first 100 releases for performance</em>' : ''}</div>`;
        }
        results.innerHTML = html;
        setTimeout(() => observeImages(), 100);
    }

    window.searchForArtist = function(artistName) {
        document.getElementById('artistInput').value = artistName;
        searchArtist();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    document.getElementById('artistInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchArtist();
    });
})();
</script>
{% endblock %}
